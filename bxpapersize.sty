% bxpapersize.sty

%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bxpapersize}[2017/02/05 v0.3pre]

%% preparation
\def\bxpr@pkgname{bxpapersize}
\providecommand\bxDebug[1]{}

%--------------------------------------- options

%% 'disabled' / 'nodvidriver'
\chardef\bxpr@disabled=0
\DeclareOption{disabled}{%
  \chardef\bxpr@disabled=1 }
\DeclareOption{nodvidriver}{%
  \chardef\bxpr@disabled=1 }
%% 'olddvips'
\chardef\bxpr@olddvips=0
\DeclareOption{olddvips}{%
  \chardef\bxpr@olddvips=1 }
%% keyval
\@onlypreamble\bxpr@kvopt
\let\bxpr@kvopt\@empty
\DeclareOption*{%
  \edef\bxpr@kvopt{\bxpr@kvopt,\CurrentOption}}
\ProcessOptions*

%% If 'disabled' is given, quit now.
\ifnum\bxpr@disabled>\z@
  \providecommand*\papersizesetup{\bxpapersizesetup}%
  \newcommand*\bxpapersizesetup[1]{}%
\expandafter\endinput\fi\relax

%--------------------------------------- general

%% load packages
\RequirePackage{xkeyval}
\RequirePackage{atbegshi}
\RequirePackage{ifpdf,ifxetex,ifluatex,ifvtex}

%% variables
\newdimen\bxpr@dima
\newif\ifbxpr@active
\let\bxpr@width\relax
\let\bxpr@height\relax

%% constants
\chardef\bxpr@mode@@dvimode=0
\chardef\bxpr@mode@@pdfmode=1

%% \bxpr@pagewidth / \bxpr@pageheight
%% \bxpr@horigin / \bxpr@vorigin
\ifluatex           % LuaTeX
  \ifx\pagewidth\@undefined % old version
    \let\bxpr@pagewidth\pdfpagewidth
    \let\bxpr@pageheight\pdfpageheight
  \else % new version
    \let\bxpr@pagewidth\pagewidth
    \let\bxpr@pageheight\pageheight
  \fi
  \ifx\pdfvariable\@undefined % old version
    \let\bxpr@horigin\pdfhorigin
    \let\bxpr@vorigin\pdfvorigin
  \else % new version
    \edef\bxpr@horigin{\pdfvariable horigin}
    \edef\bxpr@vorigin{\pdfvariable vorigin}
  \fi
\else\ifxetex       % XeTeX
  % treated as dvi-mode
\else\ifvtex        % VTeX
  \let\bxpr@pagewidth\mediawidth
  \let\bxpr@pageheight\mediaheight
\else\ifpdf         % pdfTeX in PDF mode
  \let\bxpr@pagewidth\pdfpagewidth
  \let\bxpr@pageheight\pdfpageheight
  \let\bxpr@horigin\pdfhorigin
  \let\bxpr@vorigin\pdfvorigin
\fi\fi\fi\fi
\ifx\bxpr@horigin\@undefined % fallback
  \def\bxpr@horigin{1truein }
  \def\bxpr@vorigin{1truein }
\fi

%% \bxpr@mode
\ifx\bxpr@pagewidth\@undefined
  \let\bxpr@mode\bxpr@mode@@dvimode
\else
  \let\bxpr@mode\bxpr@mode@@pdfmode
\fi

%% \bxpr@csletcs{<CSa>}{<CSb>}
\def\bxpr@csletcs#1#2{%
  \expandafter\let\csname#1\expandafter\endcsname\csname#2\endcsname}

%--------------------------------------- parameters

%% constants
\chardef\bxpr@priority@@low=0
\chardef\bxpr@priority@@middle=1
\chardef\bxpr@priority@@default=1
\chardef\bxpr@priority@@high=2
\ifnum\bxpr@olddvips>\z@
  \chardef\bxpr@priority@@low=2
  \chardef\bxpr@priority@@high=0
\fi
\chardef\bxpr@size@@real=0 %'real', use \paperwidth/height
\chardef\bxpr@size@@realS=1 %'real*'
\bxpr@csletcs{bxpr@size@@real*}{bxpr@size@@realS}
\chardef\bxpr@size@@box=2 %'box', use shipout box size
\chardef\bxpr@size@@boxS=3 %'box*'
\bxpr@csletcs{bxpr@size@@box*}{bxpr@size@@boxS}
\chardef\bxpr@size@@custom=4 % size explicitly given

%% variables
\let\bxpr@priority\bxpr@priority@@default
\let\bxpr@size\bxpr@size@@real
\def\bxpr@cs@width{\z@}%  custom page width
\def\bxpr@cs@height{\z@}% custom page height

%% error message
\def\bxpr@err@nlprm#1{%
  \PackageError\bxpr@pkgname
   {You can set '#1' only in preamble}%
   \@ehc}
\def\bxpr@err@ivval#1#2{%
  \PackageError\bxpr@pkgname
   {Invalid value for '#1': #2}%
   \@ehc}

%% 'active'
\define@boolkey+{bxpr}{active}%
 {\@nameuse{bxpr@active#1}}%
 {\bxpr@ivval{active}{#1}}
\bxpr@activetrue

%% 'priority'
\define@choicekey*+{bxpr}{priority}%
    {low,middle,default,high}%
 {\bxpr@set@priority{#1}}%
 {\bxpr@ivval{priority}{#1}}
\def\bxpr@set@priority#1{%
  \bxpr@csletcs{bxpr@priority}{bxpr@priority@@#1}}
\AtBeginDocument{%
  \def\bxpr@set@priority#1{% invalidate
    \bxpr@err@nlprm{priority}}}

%% 'size'
\define@choicekey*+{bxpr}{size}%
    {real,real*,box,box*}%
 {\bxpr@csletcs{bxpr@size}{bxpr@size@@#1}}%
 {% custom page size ('size={<width>,<height>}')
  \def\bxpr@tmpa##1,##2,##3\@nil{%
    \begingroup\setbox\z@\hbox{%
      \@tempdima##1\relax \@tempdimb##2\relax
      \xdef\bxpr@g@next{%
        \def\noexpand\bxpr@cs@width{\the\@tempdima}%
        \def\noexpand\bxpr@cs@height{\the\@tempdimb}}}%
    \endgroup\bxpr@g@next}%
  \bxpr@tmpa#1,,\@nil
  \let\bxpr@size\bxpr@size@@custom}

%% apply package options
\edef\bxpr@tmpa{%
  \noexpand\setkeys{bxpr}{\bxpr@kvopt}%
}\bxpr@tmpa

%--------------------------------------- user interface

%%<*> \bxpapersizesetup{<key>=<value>,...}
\newcommand*\bxpapersizesetup[1]{%
  \setkeys{bxpr}{#1}}
%%<*> \papersizesetup{<key>=<value>,...}
% Synonym for \bxpapersizesetup, declared only if not yet defined.
\providecommand*\papersizesetup{%
  \bxpapersizesetup}

%--------------------------------------- page hook

%% \bxpr@begindoc@first@hook
% Placed at the head of the begin-docuemnt hook.
\@onlypreamble\bxpr@begindoc@first@hook
\let\bxpr@begindoc@first@hook\@empty
\begingroup
  \toks@\expandafter{\@begindocumenthook}
  \xdef\@begindocumenthook{%
    \noexpand\bxpr@begindoc@first@hook
    \the\toks@}
\endgroup

%% \bxpr@begindoc@last@hook
% Placed after the begin-docuemnt hook.
\def\bxpr@begindoc@last@hook{%
  \let\bxpr@begindoc@last@hook\@undefined}
\g@addto@macro\document{%
  \bxpr@begindoc@last@hook}

%% add hook for every page
\g@addto@macro\bxpr@begindoc@first@hook{%
  \bxDebug{bxpapersize settings:^^J%
    mode=\the\bxpr@mode^^J%
    prioity=\the\bxpr@priority^^J%
    size=\the\bxpr@size}%
  \bxpr@geometry@hack
  \ifcase\bxpr@mode % dvi
    \ifcase\bxpr@priority % low
      \AtBeginShipoutInit
      \def\bxpr@every@page@hook{%
        \bxpr@page@process
        \bxpr@modify@output@box\bxpr@special@chunk\relax
        \AtBeginShipoutNext{\bxpr@every@page@hook}}%
      \AtBeginShipoutNext{%
        \bxpr@page@process
        \AtBeginShipoutNext{\bxpr@every@page@hook}}%
      \AtBeginShipoutFirst{\bxpr@special@chunk}
    \or % default
      \def\bxpr@every@page@hook{%
        \bxpr@page@process
        \bxpr@modify@output@box\relax\bxpr@special@chunk}%
      \AtBeginShipout{\bxpr@every@page@hook}%
    \or % higih
      \AtBeginShipoutInit
      \def\bxpr@every@page@hook{%
        \bxpr@page@process
        \bxpr@modify@output@box\relax\bxpr@special@chunk
        \AtBeginShipoutNext{\bxpr@every@page@hook}}%
      \AtBeginShipoutNext{\bxpr@every@page@hook}%
    \fi
  \else % pdf
    \def\bxpr@every@page@hook{%
      \bxpr@page@process
      \bxpr@modify@output@box\relax\bxpr@special@chunk}%
    \AtBeginShipout{\bxpr@every@page@hook}%
  \fi}

%% \bxpr@tombow
\chardef\bxpr@tombow=0
\expandafter\ifx\csname iftombow\expandafter\endcsname
    \csname iftrue\endcsname
  \chardef\bxpr@tombow=1
\fi

%% \bxpr@modify@output@box{<pre>}{<post>}
\def\bxpr@modify@output@box#1#2{%
  \setbox\AtBeginShipoutBox\vbox{%
    #1\box\AtBeginShipoutBox#2}}

%--------------------------------------- geometry hack

% The geometry package sets \paperwidth/height to incorrect
% values after its begin-document hook when magnification is
% in effect. For example, when \mag=2000 and the actual paper
% width is 100pt (=200truept), geometry will set \paperwidth
% to 200pt (=400truept), which is clearly incorrect.
% This behavior seems intentional, but I don't know the reason.
% At least it is harmful to the function of this package, so
% that I fixed it by simply revoking the change by geometry.

%% \bxpr@geometry@hack
\@onlypreamble\bxpr@geometry@hack
\def\bxpr@geometry@hack{%
  \@ifpackageloaded{geometry}{%
    \edef\bxpr@tmpa{%
      \paperwidth=\the\paperwidth
      \paperheight=\the\paperheight}%
    \expandafter\g@addto@macro\expandafter\bxpr@begindoc@last@hook
        \expandafter{\bxpr@tmpa}%
  }{}}

%--------------------------------------- per-page process

%% \bxpr@special@chunk
\let\bxpr@special@chunk\@empty

%% \bxpr@set@page@size{<width>}{<height>}
\ifcase\bxpr@mode %dvi
  \def\bxpr@set@page@size#1#2{%
    \begingroup
      \bxpr@let@real@mag@to\bxpr@tmpa
      \paperwidth=#1\relax \paperwidth=\bxpr@tmpa\paperwidth
      \paperheight=#2\relax \paperheight=\bxpr@tmpa\paperheight
      \xdef\bxpr@g@next{%
        \def\noexpand\bxpr@tmpb{\the\paperwidth,\the\paperheight}}%
    \endgroup \bxpr@g@next
    \bxDebug{papersize=\bxpr@tmpb}%
    \edef\bxpr@special@chunk{\special{papersize=\bxpr@tmpb}}}%
\else %pdf
  \def\bxpr@set@page@size#1#2{%
    \bxpr@pagewidth=#1\relax \bxpr@pageheight=#2\relax
    \bxDebug{papersize=\the\bxpr@pagewidth,\the\bxpr@pageheight}}%
\fi

%% \bxpr@let@real@mag@to\CS
\def\bxpr@let@real@mag@to#1{%
  \begingroup
    \@tempcnta=\mag \advance\@tempcnta100000
    \def\bxpr@tmpa1##1##2##3##4##5\relax{%
      \@tempdima=##1##2.##3##4##5\p@}%
    \expandafter\bxpr@tmpa\the\@tempcnta\relax
    \xdef\bxpr@g@next{%
      \def\noexpand#1{\strip@pt\@tempdima}}%
  \endgroup \bxpr@g@next}

%% \bxpr@page@process
\def\bxpr@page@process{%
  \ifbxpr@active
    \bxpr@page@process@a
  \fi}
\def\bxpr@page@process@a{%
  \ifcase\bxpr@size % real
    \bxpr@use@real@size
    \bxpr@set@page@size{\bxpr@width}{\bxpr@height}%
  \or % real*
    \bxpr@set@page@size{\paperwidth}{\paperheight}%
  \or % box
    \bxpr@use@box@size
    \setbox\AtBeginShipoutBox\vbox{%
      \kern-\bxpr@vorigin
      \moveleft\bxpr@horigin\box\AtBeginShipoutBox}%
    \bxpr@set@page@size{\bxpr@width}{\bxpr@height}%
  \or % box*
    \bxpr@use@box@size
    \bxpr@set@page@size{\bxpr@width}{\bxpr@height}%
  \else % custom
    \bxpr@set@page@size{\bxpr@cs@width}{\bxpr@cs@height}%
  \fi}

%% \bxpr@use@real@size
\def\bxpr@use@real@size{%
  \bxpr@use@real@size@a{width}%
  \bxpr@use@real@size@a{height}}
\def\bxpr@use@real@size@a#1{%
  \begingroup
    \bxpr@csletcs{bxpr@tmpa}{paper#1}%
    \ifnum\bxpr@tombow>\z@
      \advance\bxpr@tmpa2in\relax
    \fi
    \bxpr@csletcs{bxpr@tmpb}{stock#1}%
    \ifx\bxpr@tmpb\relax\else \ifdim\bxpr@tmpb>\z@
      \bxpr@tmpa\bxpr@tmpb
    \fi\fi
    \xdef\bxpr@g@next{%
      \def\expandafter\noexpand\csname bxpr@#1\endcsname{%
        \the\bxpr@tmpa}}
  \endgroup \bxpr@g@next}

%% \bxpr@use@box@size
\def\bxpr@use@box@size{%
  \edef\bxpr@width{\the\wd\AtBeginShipoutBox}%
  \bxpr@dima\ht\AtBeginShipoutBox
  \advance\bxpr@dima\dp\AtBeginShipoutBox
  \edef\bxpr@height{\the\bxpr@dima}}

%--------------------------------------- all done
\endinput
%% EOF
